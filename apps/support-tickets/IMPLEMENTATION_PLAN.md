# Support Tickets App - Implementation Plan

**Status:** Implementation ~88% Complete - Core Features Done, Polish Remaining
**Last Updated:** 2025-10-17

---

## Overview

Build a comprehensive support ticket system using **Replyke only** (no backend server required). Users can submit tickets, upvote/downvote issues they also experience, discuss solutions via threaded comments, and mark tickets as resolved.

---

## Core Architecture

### 1. Data Model (Using Replyke Entities)

Each ticket is a Replyke **Entity** with:

- **sourceId:** `"support-tickets"` (critical for separating ticket entities from other content)
- **Auto-generated by Replyke:**
  - `id`: UUID for internal use
  - `shortId`: User-friendly identifier for URLs (e.g., `/tickets/abc123`)
  - `user`: Creator information
  - `upvotes`/`downvotes`: Arrays of user IDs
  - `repliesCount`: Comment count

- **Developer-provided fields:**
  - `title`: Ticket title/summary (string)
  - `content`: Detailed description (string, markdown supported)
  - `keywords`: Tags for categorization (string[])
  - `metadata`: Custom fields (Record<string, any>, max 10KB)
    - `status`: "open" | "in-progress" | "resolved"
    - `priority`: "low" | "medium" | "high" | "critical" | null (admin/editor only)
    - `category`: "bug" | "feature-request" | "question" | "documentation" | "other"
    - `resolvedAt`: ISO timestamp when marked resolved
    - `resolvedBy`: User ID who marked it resolved

---

## 2. Page Structure

### Home Page (`/`)
**Purpose:** Main ticket listing and filtering

**Features:**
- Entity list showing all tickets (useEntityList)
- Filter controls:
  - Status filter (open/in-progress/resolved)
  - Category filter
  - "My Tickets" toggle (filters by current userId)
  - **Admin/Editor only:** Priority filter
  - Sort options: hot, new, top, controversial
  - Search by title/content/keywords
- "Create New Ticket" button (opens `/create-ticket`)
- Ticket cards displaying:
  - Title
  - Status badge
  - Category badge
  - **Admin/Editor only:** Priority badge
  - Vote count
  - Comment count
  - Author info
  - Created date

### Create Ticket Page (`/create-ticket`)
**Purpose:** Form to submit new tickets

**Form Fields:**
- Title (required, text input)
- Description (required, markdown editor using @uiw/react-md-editor)
- Category (required, select dropdown)
- Keywords (optional, tag input)
- **Admin/Editor only:** Priority (select dropdown)

**Submission:**
- Uses `useCreateEntity` hook
- Creates entity with:
  ```typescript
  {
    sourceId: "support-tickets",
    title,
    content,
    keywords,
    metadata: {
      status: "open",
      category,
      priority: (userRole === 'admin' || userRole === 'editor') ? priority : null
    }
  }
  ```
- Redirects to ticket detail page on success

### Ticket Detail Page (`/tickets/[shortId]`)
**Purpose:** Full ticket view with discussion

**Data Loading:**
- Use `useFetchEntityByShortId` to load ticket by shortId from URL
- Wrap entire page content in `<EntityProvider>` to access voting functions

**Sections:**
1. **Ticket Header:**
   - Title
   - Status badge (with edit dropdown for author)
   - Category badge
   - **Admin/Editor only:** Priority badge
   - Author info with avatar
   - Created/updated timestamps

2. **Ticket Content:**
   - Markdown-rendered description
   - Keywords/tags

3. **Voting Section:**
   - Upvote/downvote buttons
   - Vote count display
   - Uses functions from `useEntity`: `upvoteEntity`, `downvoteEntity`, `removeEntityUpvote`, `removeEntityDownvote`

4. **Actions:**
   - **Author only:** "Mark as Resolved" button (if status !== 'resolved')
   - **Author only:** "Reopen" button (if status === 'resolved')
   - **Author or Admin/Editor:** "Edit" button → `/tickets/[shortId]/edit`
   - **Author or Admin/Editor:** "Delete" button (with confirmation)

5. **Discussion Section:**
   - `<ThreadedCommentSection foreignId={entity.id} />` (NOT shortId)
   - Comment voting handled automatically by Replyke
   - Callbacks for authentication

### Edit Ticket Page (`/tickets/[shortId]/edit`)
**Purpose:** Edit existing ticket

**Permissions:**
- Author can edit: title, content, category, keywords, status
- Admin/Editor can additionally edit: priority, any ticket

**Form:**
- Pre-populated with current values
- Same fields as create form
- Uses `useUpdateEntity` hook
- Redirects back to detail page on success

---

## 3. Key Features

### Ticket Management

**Create Ticket:**
- Form validation (title and content required)
- Markdown support for descriptions
- Auto-assigns current user as author
- Sets initial status to "open"

**Edit Ticket:**
- Author or Admin/Editor can update
- Preserves metadata structure
- Updates `updatedAt` timestamp automatically

**Delete Ticket:**
- Author or Admin/Editor only
- Confirmation dialog required
- Uses `deleteEntity` from useEntity

**Mark as Resolved:**
- Author only
- Updates metadata:
  ```typescript
  {
    status: "resolved",
    resolvedAt: new Date().toISOString(),
    resolvedBy: currentUser.id
  }
  ```
- Uses `updateEntity` from useEntity

**Reopen Ticket:**
- Author only
- Updates metadata:
  ```typescript
  {
    status: "open",
    resolvedAt: null,
    resolvedBy: null
  }
  ```

### Voting System

**Implementation:**
- Use `useEntity` hook (within EntityProvider) which provides:
  - `upvoteEntity()` - Adds upvote, removes downvote if exists
  - `removeEntityUpvote()` - Removes upvote
  - `downvoteEntity()` - Adds downvote, removes upvote if exists
  - `removeEntityDownvote()` - Removes downvote
  - `userUpvotedEntity` - Boolean flag
  - `userDownvotedEntity` - Boolean flag

**UI:**
- Upvote button (highlighted if `userUpvotedEntity`)
- Vote count display
- Downvote button (highlighted if `userDownvotedEntity`)
- Optimistic updates (immediate UI change)

**Sorting:**
- "top" - Most upvoted
- "controversial" - High engagement (both up and down)
- "hot" - Trending based on recent activity

### Discussion System

**Implementation:**
- Use `<ThreadedCommentSection>` from `@replyke/comments-threaded-react-js`
- Pass `foreignId={entity.id}` (NOT shortId)
- Comment voting automatically handled by Replyke
- No need for custom comment components

**Features (Built-in):**
- Unlimited nesting for threaded discussions
- Upvote/downvote on comments
- Reply to comments
- Mention users with @username
- GIF support
- Collapsible threads

**Callbacks:**
```typescript
<ThreadedCommentSection
  foreignId={entity.id}
  callbacks={{
    loginRequiredCallback: () => {
      // Open AuthDialog
    },
    usernameRequiredCallback: () => {
      // Prompt to set username
    },
    currentUserClickCallback: () => {
      // Navigate to user profile/settings
    },
    otherUserClickCallback: (userId: string) => {
      // Navigate to user profile
    }
  }}
/>
```

### Filtering & Search

**Status Filter:**
```typescript
metadataFilters: {
  includes: { status: "open" }
}
```

**Category Filter:**
```typescript
metadataFilters: {
  includes: { category: "bug" }
}
```

**Priority Filter (Admin/Editor only):**
```typescript
metadataFilters: {
  includes: { priority: "high" }
}
```

**My Tickets:**
```typescript
userId: currentUser.id
```

**Keyword Search:**
```typescript
keywordsFilters: {
  includes: ["api", "authentication"]
}
```

**Title Search:**
```typescript
titleFilters: {
  includes: ["login error"]
}
```

**Content Search:**
```typescript
contentFilters: {
  includes: ["database"]
}
```

**Sort Options:**
- `sortBy: "hot"` - Trending (default)
- `sortBy: "new"` - Most recent
- `sortBy: "top"` - Most upvoted
- `sortBy: "controversial"` - Most debated

### Role-Based Features

**Role Detection:**
- User role from Replyke user object: `user.role`
- Check if admin/editor: `['admin', 'editor'].includes(user.role)`

**Admin/Editor Capabilities:**
- Set and edit priority on any ticket
- See priority badges and filters
- Edit any ticket (not just own)
- Delete any ticket

**Regular User Capabilities:**
- Create tickets (no priority field)
- Edit/delete only own tickets
- Mark own tickets as resolved
- Vote on any ticket
- Comment on any ticket

**Conditional Rendering:**
```typescript
{(userRole === 'admin' || userRole === 'editor') && (
  <PriorityBadge priority={ticket.metadata.priority} />
)}
```

### Authentication

**Integration:**
- Existing ReplykeProvider with projectId
- Login required for: creating tickets, voting, commenting
- Unauthenticated actions trigger callbacks

**Callbacks:**
- `loginRequiredCallback` → Open AuthDialog
- `usernameRequiredCallback` → Prompt to set username
- Show appropriate messages via toast (sonner)

---

## 4. UI Components

### Component List

**TicketCard.tsx**
- Displays ticket in list view
- Props: entity, currentUser
- Shows: title, status, category, votes, comments, author, date
- Conditional: priority badge (admin/editor only)
- Click → Navigate to `/tickets/[shortId]`

**TicketList.tsx**
- Container for ticket cards
- Handles loading states
- Infinite scroll with `loadMore` from useEntityList
- Empty state when no tickets

**TicketFilters.tsx**
- Filter controls
- Props: currentFilters, onFilterChange, currentUser
- Filters: status, category, my tickets toggle, sort
- Conditional: priority filter (admin/editor only)
- Search inputs: title, content, keywords

**CreateTicketForm.tsx**
- Form for new tickets
- Fields: title, description (markdown), category, keywords
- Conditional: priority (admin/editor only)
- Validation and error handling
- Uses useCreateEntity

**EditTicketForm.tsx**
- Similar to CreateTicketForm
- Pre-populated with current values
- Uses useUpdateEntity

**TicketDetail.tsx**
- Full ticket display
- Must be wrapped in EntityProvider
- Sections: header, content, voting, actions
- Uses useEntity for voting functions

**StatusBadge.tsx**
- Visual status indicator
- Props: status ("open" | "in-progress" | "resolved")
- Color-coded: open (blue), in-progress (yellow), resolved (green)

**PriorityBadge.tsx**
- Priority indicator (admin/editor only)
- Props: priority ("low" | "medium" | "high" | "critical" | null)
- Color-coded: low (gray), medium (yellow), high (orange), critical (red)

**CategoryBadge.tsx**
- Category indicator
- Props: category
- Displays with icon and text

**VoteButtons.tsx**
- Voting UI component
- Must be used within EntityProvider
- Uses useEntity hook for voting functions
- Shows current vote count
- Highlights active vote state
- Handles optimistic updates

**ResolveButton.tsx**
- Button to mark ticket as resolved
- Props: entity, onResolve
- Author-only (permission check)
- Confirmation dialog
- Updates metadata via useUpdateEntity

---

## 5. Technical Implementation

### Dependencies (Already Installed)

```json
{
  "@replyke/react-js": "6.0.0",
  "@replyke/comments-threaded-react-js": "6.0.0",
  "@uiw/react-md-editor": "^4.0.5",
  "next": "15.2.4",
  "react": "^19",
  "lucide-react": "^0.454.0",
  "sonner": "^1.7.4",
  "tailwindcss": "^3.4.17"
}
```

### Hooks to Use

**useEntityList**
- Purpose: Manage ticket feeds with filters
- Usage: Home page ticket list
- Provides: entities, loading, hasMore, fetchEntities, loadMore

**useCreateEntity**
- Purpose: Create new tickets
- Usage: Create ticket form
- Returns: createEntity function

**useUpdateEntity**
- Purpose: Update ticket metadata
- Usage: Edit form, resolve/reopen actions
- Returns: updateEntity function

**useEntity**
- Purpose: Access entity data and functions (including voting)
- Usage: Within EntityProvider on ticket detail page
- Provides: entity, upvoteEntity, downvoteEntity, removeEntityUpvote, removeEntityDownvote, userUpvotedEntity, userDownvotedEntity, updateEntity, deleteEntity

**useFetchEntityByShortId**
- Purpose: Fetch ticket by shortId from URL
- Usage: Ticket detail page
- Returns: fetchEntityByShortId function

**useUser**
- Purpose: Get current user info and role
- Usage: Throughout app for permission checks
- Provides: user object with role

**ThreadedCommentSection (Component)**
- Purpose: Complete discussion system
- Usage: Ticket detail page
- Handles: Comments, replies, voting, threading

### State Management

- **Replyke Hooks:** Built-in Redux state management
- **Local State:** React useState for:
  - Filter selections
  - Form inputs
  - UI toggles (dialogs, dropdowns)
- **URL State:** Next.js router for:
  - shortId parameter
  - Search params for filters

---

## 6. Implementation Phases

### ✅ Phase 1: Setup & Constants - COMPLETE
**Goal:** Establish foundation

**Tasks:**
- [x] Create `src/types/ticket.ts` with TypeScript types
- [x] Create `src/lib/constants.ts` with status/priority/category constants
- [x] Create `src/lib/ticket-helpers.ts` with utility functions
- [x] Set up folder structure under `src/components/Tickets/`

**Estimated Time:** 1 hour
**Status:** ✅ 100% Complete

---

### ✅ Phase 2: Basic Ticket Creation & Listing - COMPLETE
**Goal:** Users can create and view tickets

**Tasks:**
- [x] Create `TicketCard.tsx` component (basic version)
- [x] Create `TicketList.tsx` component
- [x] Create `StatusBadge.tsx` component
- [x] Create `CategoryBadge.tsx` component
- [x] Implement home page (`src/app/page.tsx`):
  - [x] Set up useEntityList with sourceId="support-tickets"
  - [x] Render TicketList with ticket cards
  - [x] Add "Create Ticket" button
  - [x] Basic loading state
- [x] Create `CreateTicketForm.tsx`:
  - [x] Form inputs (title, description, category, keywords)
  - [x] Markdown editor for description
  - [x] Role-aware priority field (admin/editor only)
  - [x] Form validation
- [x] Implement create ticket page (`src/app/create-ticket/page.tsx`):
  - [x] Render CreateTicketForm
  - [x] Handle form submission with useCreateEntity
  - [x] Redirect to ticket detail on success
  - [x] Error handling

**Estimated Time:** 4-6 hours
**Status:** ✅ 100% Complete

---

### ✅ Phase 3: Ticket Detail & Voting - COMPLETE
**Goal:** Users can view full tickets and vote

**Tasks:**
- [x] Create ticket detail page (`src/app/tickets/[shortId]/page.tsx`):
  - [x] Use useFetchEntityByShortId to load ticket
  - [x] Wrap content in EntityProvider
  - [x] Handle loading/error states
  - [x] Display ticket header with metadata
  - [x] Render markdown content
- [x] Create `VoteButtons.tsx`:
  - [x] Use useEntity hook (must be within EntityProvider)
  - [x] Implement upvote/downvote buttons
  - [x] Display vote count
  - [x] Show active vote state
  - [x] Optimistic updates
- [x] Create `TicketDetail.tsx` component:
  - [x] Full ticket display
  - [x] Integrate VoteButtons
  - [x] Show author info, timestamps
  - [x] Display badges (status, category, priority)
- [x] Update TicketCard to link to detail page using shortId

**Estimated Time:** 4-6 hours
**Status:** ✅ 100% Complete

---

### ✅ Phase 4: Status Management - COMPLETE
**Goal:** Authors can manage ticket status

**Tasks:**
- [x] Create `ResolveButton.tsx`:
  - [x] Permission check (author only)
  - [x] "Mark as Resolved" button
  - [x] Confirmation dialog
  - [x] Update metadata with useUpdateEntity
  - [x] Set resolvedAt and resolvedBy
- [x] Add "Reopen" functionality:
  - [x] Show when status is "resolved"
  - [x] Clear resolvedAt and resolvedBy
  - [x] Update status to "open"
- [x] Add status change dropdown:
  - [x] Author can change: open ↔ in-progress ↔ resolved
  - [x] Update UI optimistically
- [x] Update TicketCard to show resolved state clearly
- [x] Add status filter to home page (stub for now)

**Estimated Time:** 3-4 hours
**Status:** ✅ 100% Complete

---

### ✅ Phase 5: Comments & Discussion - COMPLETE
**Goal:** Users can discuss tickets

**Tasks:**
- [x] Integrate ThreadedCommentSection in ticket detail:
  - [x] Import from @replyke/comments-threaded-react-js
  - [x] Pass foreignId={entity.id}
  - [x] Configure callbacks:
    - [x] loginRequiredCallback → AuthDialog
    - [x] usernameRequiredCallback → Toast notification
    - [x] currentUserClickCallback → Profile (if exists)
    - [x] otherUserClickCallback → User profile (if exists)
- [x] Style threaded comments to match app theme
- [x] Test comment creation, replies, voting
- [x] Display comment count in TicketCard

**Estimated Time:** 2-3 hours
**Status:** ✅ 100% Complete

---

### ✅ Phase 6: Advanced Filters - COMPLETE
**Goal:** Users can filter and search tickets

**Tasks:**
- [x] Create `TicketFilters.tsx` component:
  - [x] Status filter (dropdown/tabs)
  - [x] Category filter (dropdown)
  - [x] "My Tickets" toggle
  - [x] Sort options (dropdown)
  - [x] Admin/Editor: Priority filter
  - [x] Search inputs (title, keywords)
- [x] Connect filters to useEntityList:
  - [x] Implement metadataFilters for status
  - [x] Implement metadataFilters for category
  - [x] Implement userId filter for "My Tickets"
  - [x] Implement keywordsFilters
  - [x] Implement titleFilters
  - [x] Implement sortBy changes
- [x] Add filter state to URL search params
- [x] Persist filter state across navigation
- [x] Add "Clear Filters" button

**Estimated Time:** 4-5 hours
**Status:** ✅ 100% Complete

---

### ✅ Phase 7: Role Management - COMPLETE
**Goal:** Admin/Editor features work correctly

**Tasks:**
- [x] Create role detection utility:
  - [x] Check user.role from useUser
  - [x] Helper: isAdminOrEditor(user)
- [x] Create `PriorityBadge.tsx` (visible to admin/editor only)
- [x] Update CreateTicketForm:
  - [x] Show priority field for admin/editor
  - [x] Hide for regular users
- [x] Update TicketCard:
  - [x] Conditionally show priority badge
- [x] Update TicketDetail:
  - [x] Show priority for admin/editor
  - [x] Allow priority editing (admin/editor)
- [x] Update TicketFilters:
  - [x] Show priority filter for admin/editor only
- [x] Implement permission checks:
  - [x] Edit any ticket (admin/editor)
  - [x] Delete any ticket (admin/editor)
  - [x] Set/change priority (admin/editor)

**Estimated Time:** 3-4 hours
**Status:** ✅ 100% Complete

---

### ✅ Phase 8: Edit Functionality - COMPLETE
**Goal:** Users can edit tickets

**Tasks:**
- [x] Create edit ticket page (`src/app/tickets/[shortId]/edit/page.tsx`):
  - [x] Load ticket with useFetchEntityByShortId
  - [x] Permission check (author or admin/editor)
  - [x] Render EditTicketForm with current values
- [x] Create `EditTicketForm.tsx`:
  - [x] Pre-populate all fields
  - [x] Same fields as CreateTicketForm
  - [x] Use useUpdateEntity on submit
  - [x] Handle partial updates (preserve other metadata)
- [x] Add "Edit" button to TicketDetail:
  - [x] Show for author or admin/editor
  - [x] Link to edit page
- [x] Add "Delete" functionality:
  - [x] Show for author or admin/editor
  - [x] Confirmation dialog (AlertDialog)
  - [x] Use deleteEntity from useEntity
  - [x] Redirect to home after delete

**Estimated Time:** 3-4 hours
**Status:** ✅ 100% Complete

---

### ⚠️ Phase 9: Polish & UX - PARTIALLY COMPLETE
**Goal:** Production-ready experience

**Tasks:**
- [ ] Loading states:
  - [ ] Skeleton loaders for ticket cards (NOT DONE - using spinner instead)
  - [x] Loading spinner for detail page
  - [x] Loading state during voting
  - [x] Loading state during form submission
- [x] Error handling:
  - [x] Error boundaries
  - [x] Toast notifications for errors
  - [x] Graceful fallbacks
  - [ ] Retry mechanisms (MINIMAL)
- [x] Optimistic updates:
  - [x] Voting (already built-in)
  - [x] Status changes
  - [x] Comment count updates
- [x] Responsive design:
  - [x] Mobile-friendly filters (drawer/sheet)
  - [x] Responsive ticket cards
  - [x] Mobile-optimized forms
  - [x] Touch-friendly vote buttons
- [x] Accessibility:
  - [x] Keyboard navigation
  - [x] ARIA labels
  - [ ] Screen reader support (BASIC - needs testing)
  - [ ] Focus management (BASIC - could improve)
- [ ] SEO:
  - [ ] Dynamic metadata for ticket pages (BASIC - could enhance)
  - [x] Proper heading hierarchy
  - [ ] Structured data (JSON-LD) (NOT DONE)
- [x] Empty states:
  - [x] No tickets found
  - [x] No search results
  - [x] My tickets empty state
- [x] Success feedback:
  - [x] Toast on ticket created
  - [x] Toast on ticket updated
  - [x] Toast on vote
  - [x] Toast on resolve

**Estimated Time:** 6-8 hours
**Status:** ⚠️ ~75% Complete - Functional but could be enhanced with skeleton loaders, improved SEO, and better accessibility testing

---

## 7. File Structure

```
apps/support-tickets/
├── src/
│   ├── app/
│   │   ├── page.tsx                      # Home page with ticket list
│   │   ├── layout.tsx                     # Root layout (existing)
│   │   ├── globals.css                    # Global styles (existing)
│   │   ├── create-ticket/
│   │   │   └── page.tsx                   # Create ticket form page
│   │   └── tickets/
│   │       └── [shortId]/
│   │           ├── page.tsx               # Ticket detail page
│   │           └── edit/
│   │               └── page.tsx           # Edit ticket page
│   │
│   ├── components/
│   │   ├── Layout/                        # Existing layout components
│   │   ├── AuthDialog/                    # Existing auth components
│   │   ├── ui/                            # Existing shadcn components
│   │   └── Tickets/                       # NEW: Ticket components
│   │       ├── TicketCard.tsx             # List item component
│   │       ├── TicketList.tsx             # List container
│   │       ├── TicketFilters.tsx          # Filter controls
│   │       ├── CreateTicketForm.tsx       # Create form
│   │       ├── EditTicketForm.tsx         # Edit form
│   │       ├── TicketDetail.tsx           # Detail view
│   │       ├── StatusBadge.tsx            # Status indicator
│   │       ├── PriorityBadge.tsx          # Priority indicator
│   │       ├── CategoryBadge.tsx          # Category indicator
│   │       ├── VoteButtons.tsx            # Voting UI
│   │       └── ResolveButton.tsx          # Resolve action
│   │
│   ├── lib/
│   │   ├── utils.ts                       # Existing utilities
│   │   ├── handle-error.ts                # Existing error handling
│   │   ├── time-formatters.ts             # Existing time utils
│   │   ├── constants.ts                   # NEW: App constants
│   │   └── ticket-helpers.ts              # NEW: Ticket utilities
│   │
│   ├── types/
│   │   └── ticket.ts                      # NEW: TypeScript types
│   │
│   ├── context/
│   │   ├── context-providers.tsx          # Existing (includes ReplykeProvider)
│   │   └── posthog-provider.tsx           # Existing analytics
│   │
│   └── hooks/
│       ├── useMediaQuery.tsx              # Existing
│       └── use-mobile.tsx                 # Existing
│
├── public/                                 # Static assets (existing)
├── package.json                            # Dependencies (existing)
├── tsconfig.json                           # TypeScript config (existing)
├── tailwind.config.ts                      # Tailwind config (existing)
├── next.config.mjs                         # Next.js config (existing)
└── IMPLEMENTATION_PLAN.md                  # This document
```

---

## 8. Constants & Types

### src/lib/constants.ts

```typescript
export const TICKET_SOURCE_ID = "support-tickets";

export const TICKET_STATUS = {
  OPEN: "open",
  IN_PROGRESS: "in-progress",
  RESOLVED: "resolved",
} as const;

export const TICKET_STATUS_OPTIONS = [
  { value: "open", label: "Open" },
  { value: "in-progress", label: "In Progress" },
  { value: "resolved", label: "Resolved" },
];

export const TICKET_PRIORITY = {
  LOW: "low",
  MEDIUM: "medium",
  HIGH: "high",
  CRITICAL: "critical",
} as const;

export const TICKET_PRIORITY_OPTIONS = [
  { value: "low", label: "Low" },
  { value: "medium", label: "Medium" },
  { value: "high", label: "High" },
  { value: "critical", label: "Critical" },
];

export const TICKET_CATEGORY = {
  BUG: "bug",
  FEATURE_REQUEST: "feature-request",
  QUESTION: "question",
  DOCUMENTATION: "documentation",
  OTHER: "other",
} as const;

export const TICKET_CATEGORY_OPTIONS = [
  { value: "bug", label: "Bug Report" },
  { value: "feature-request", label: "Feature Request" },
  { value: "question", label: "Question" },
  { value: "documentation", label: "Documentation" },
  { value: "other", label: "Other" },
];

export const ADMIN_ROLES = ["admin", "editor"] as const;
```

### src/types/ticket.ts

```typescript
import { Entity, User } from "@replyke/react-js";

export type TicketStatus = "open" | "in-progress" | "resolved";
export type TicketPriority = "low" | "medium" | "high" | "critical" | null;
export type TicketCategory = "bug" | "feature-request" | "question" | "documentation" | "other";
export type UserRole = "admin" | "editor" | "visitor";

export interface TicketMetadata {
  status: TicketStatus;
  category: TicketCategory;
  priority: TicketPriority;
  resolvedAt?: string | null;
  resolvedBy?: string | null;
}

export interface TicketEntity extends Entity {
  metadata: TicketMetadata;
}

export interface TicketFormData {
  title: string;
  content: string;
  category: TicketCategory;
  keywords: string[];
  priority?: TicketPriority;
}

export interface TicketFilters {
  status?: TicketStatus | null;
  category?: TicketCategory | null;
  priority?: TicketPriority | null;
  myTicketsOnly?: boolean;
  search?: string;
  sortBy?: "hot" | "new" | "top" | "controversial";
}
```

---

## 9. Key Considerations

### Authentication
- **No Backend Required:** All data stored in Replyke entities
- **Current Setup:** ReplykeProvider with projectId already configured
- **Login Flow:** Existing AuthDialog components handle sign up/sign in
- **Protected Actions:** Voting, commenting, creating tickets require auth

### IDs and URLs
- **Entity IDs:** Auto-generated UUIDs by Replyke (for API use)
- **Short IDs:** Auto-generated friendly IDs by Replyke (for URLs)
- **URLs:** Use shortId → `/tickets/[shortId]`
- **Comments:** Use entity.id (not shortId) for foreignId in ThreadedCommentSection

### Permissions
- **Author Checks:** `entity.user.id === currentUser.id`
- **Role Checks:** `user.role === 'admin' || user.role === 'editor'`
- **Edit/Delete:** Author or Admin/Editor
- **Priority:** Only Admin/Editor can set/view
- **Resolve:** Only author can mark as resolved

### Entity Provider
- **Critical:** Must wrap ticket detail page content
- **Provides:** All voting functions (upvoteEntity, downvoteEntity, etc.)
- **Benefits:** Automatic state management, optimistic updates

### Metadata Management
- **Size Limit:** 10KB per entity
- **Structure:** Keep consistent schema for filtering
- **Updates:** Use spread operator to preserve unrelated fields
  ```typescript
  updateEntity({
    entityId: ticket.id,
    update: {
      metadata: {
        ...ticket.metadata,
        status: "resolved",
        resolvedAt: new Date().toISOString(),
      }
    }
  })
  ```

### Filtering Best Practices
- **Metadata Filters:** For custom fields (status, priority, category)
- **Keywords Filters:** For tag-based search
- **Title/Content Filters:** For text search
- **User ID Filter:** For "My Tickets"
- **Combine Filters:** All filters work together

### Comment Voting
- **Automatic:** Handled entirely by ThreadedCommentSection
- **No Custom Code:** Voting UI, state management, and API calls built-in
- **Just Add Component:** `<ThreadedCommentSection foreignId={entity.id} />`

### Real-time Updates
- **Built-in:** Replyke hooks use Redux for state management
- **Optimistic Updates:** UI updates immediately, reverts on error
- **Auto-sync:** State automatically updated across components

### SEO Optimization
- **Dynamic Metadata:** Generate per-ticket in page.tsx
- **Short IDs in URLs:** More shareable and user-friendly
- **Proper Headings:** Use semantic HTML
- **Structured Data:** Consider adding JSON-LD for rich snippets

---

## 10. Testing Strategy

### Manual Testing Checklist

**Ticket Creation:**
- [ ] Create ticket as regular user (no priority field)
- [ ] Create ticket as admin/editor (with priority)
- [ ] Validation works (required fields)
- [ ] Markdown renders correctly
- [ ] Keywords save properly

**Ticket Viewing:**
- [ ] Load ticket by shortId
- [ ] All metadata displays correctly
- [ ] Vote counts accurate
- [ ] Comment count accurate
- [ ] Author info shows

**Voting:**
- [ ] Upvote increments count
- [ ] Downvote decrements count
- [ ] Can't vote twice
- [ ] Upvote removes downvote (and vice versa)
- [ ] Optimistic updates work
- [ ] Login required for unauthenticated

**Status Management:**
- [ ] Author can mark as resolved
- [ ] Resolved status shows clearly
- [ ] Author can reopen
- [ ] Status changes reflect in list
- [ ] resolvedAt and resolvedBy set correctly

**Comments:**
- [ ] Can create top-level comments
- [ ] Can reply to comments (nesting)
- [ ] Comment voting works
- [ ] Mention users works
- [ ] GIF picker works
- [ ] Login required for unauthenticated

**Filtering:**
- [ ] Status filter works
- [ ] Category filter works
- [ ] "My Tickets" toggle works
- [ ] Priority filter works (admin/editor)
- [ ] Sort options work (hot/new/top/controversial)
- [ ] Keyword search works
- [ ] Title search works
- [ ] Multiple filters combine correctly

**Editing:**
- [ ] Author can edit own ticket
- [ ] Admin/editor can edit any ticket
- [ ] Admin/editor can change priority
- [ ] Updates save correctly
- [ ] Cannot edit others' tickets (regular user)

**Permissions:**
- [ ] Priority hidden for regular users
- [ ] Priority visible for admin/editor
- [ ] Edit button shows for author or admin/editor
- [ ] Delete button shows for author or admin/editor
- [ ] Resolve button shows for author only

**Responsive:**
- [ ] Mobile layout works
- [ ] Filters accessible on mobile
- [ ] Forms usable on mobile
- [ ] Voting buttons touch-friendly

---

## 11. Future Enhancements

*(Not in scope for initial implementation)*

- **Email Notifications:** Notify on comments, status changes
- **Attachments:** Allow file uploads on tickets
- **Labels/Tags:** Additional categorization beyond keywords
- **Milestones:** Group tickets by milestone/sprint
- **Duplicates:** Mark tickets as duplicates
- **Dependencies:** Link related tickets
- **Analytics Dashboard:** Ticket statistics and trends
- **Bulk Actions:** Close multiple tickets at once
- **Templates:** Pre-filled ticket templates
- **Private Tickets:** Hide certain tickets from public view
- **Watchers:** Subscribe to ticket updates
- **Activity Feed:** Global feed of ticket activity

---

## 12. Environment Variables

### Required in `.env.local`:

```
NEXT_PUBLIC_REPLYKE_PROJECT_ID=your_project_id_here
```

### Optional (if using PostHog):

```
NEXT_PUBLIC_POSTHOG_KEY=your_posthog_key
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
```

**Note:** Get your Replyke Project ID from https://dashboard.replyke.com

---

## 13. Progress Tracking

### Current Status: 🟢 MOSTLY COMPLETE - Ready for Testing & Final Polish

**Phase Completion:**
- [x] Phase 1: Setup & Constants - ✅ 100%
- [x] Phase 2: Basic Ticket Creation & Listing - ✅ 100%
- [x] Phase 3: Ticket Detail & Voting - ✅ 100%
- [x] Phase 4: Status Management - ✅ 100%
- [x] Phase 5: Comments & Discussion - ✅ 100%
- [x] Phase 6: Advanced Filters - ✅ 100%
- [x] Phase 7: Role Management - ✅ 100%
- [x] Phase 8: Edit Functionality - ✅ 100%
- [ ] Phase 9: Polish & UX - ⚠️ 75%

**Overall Progress:** ~88% Complete

**What's Working:**
- ✅ Full ticket CRUD (create, read, update, delete)
- ✅ Voting system with optimistic updates
- ✅ Status management (open/in-progress/resolved)
- ✅ Threaded comments integration
- ✅ Advanced filtering and search
- ✅ Role-based permissions (admin/editor features)
- ✅ Responsive design
- ✅ Authentication integration
- ✅ Form validation and error handling
- ✅ Toast notifications

**What Needs Work (Optional Enhancements):**
- ⚠️ Skeleton loaders (currently using spinners)
- ⚠️ Enhanced SEO with dynamic metadata
- ⚠️ JSON-LD structured data
- ⚠️ Accessibility testing (screen readers, focus management)
- ⚠️ Minor bug: CategoryBadge.tsx has duplicate icons definition

**Next Steps:**
1. Test all features with the manual testing checklist (Section 10)
2. Fix CategoryBadge.tsx duplicate icons bug
3. (Optional) Add skeleton loaders for better UX
4. (Optional) Enhance SEO metadata
5. (Optional) Accessibility audit

---

## 14. Notes & Decisions

### Decision Log:

**2025-10-16:**
- ✅ Decided to use shortId for URLs (auto-generated by Replyke)
- ✅ Priority field only for admin/editor roles
- ✅ Use EntityProvider for voting (not separate useEntityVotes)
- ✅ Comment voting handled automatically by ThreadedCommentSection
- ✅ No separate dashboard - just "My Tickets" filter on home page
- ✅ Use entity.id (not shortId) for comment foreignId

**2025-10-17:**
- ✅ Implementation status assessed - ~88% complete
- ✅ All core features (Phases 1-8) fully implemented
- ✅ Phase 9 (Polish & UX) mostly done, some optional enhancements remain
- ⚠️ Identified minor bug in CategoryBadge.tsx (duplicate icons definition)

### Open Questions:

- Should we add "In Progress" status or just Open/Resolved?
  - **Decision:** Include "In Progress" for better workflow tracking
- Default sort order for home page?
  - **Recommendation:** "hot" to show trending tickets
- Should regular users see resolved tickets by default?
  - **Recommendation:** Yes, but with option to filter them out

---

## 15. Resources

### Documentation:
- Replyke Docs: https://docs.replyke.com
- Replyke Entity Lists: https://docs.replyke.com/sdk/entity-lists/overview
- Threaded Comments: https://docs.replyke.com/sdk/comments/threaded/component
- Next.js 15 Docs: https://nextjs.org/docs
- Shadcn UI: https://ui.shadcn.com

### Support:
- Replyke Dashboard: https://dashboard.replyke.com
- GitHub Issues: (if applicable)

---

**END OF IMPLEMENTATION PLAN**

---

*This document should be updated as implementation progresses. Mark phases as complete, update progress percentage, and add notes about decisions or changes.*
